<app-page-container>
  <div class="purchase-page">
    <app-back-button [customBack]="true" (click)="goBackToProduct()" text="← Вернуться к товару"></app-back-button>

    @if (product()) {
    <div class="purchase-page__card">
      <h1 class="purchase-page__title">{{ product()?.name }}</h1>
      @if (_purchaseState() === 'initial') {
      <div class="purchase-page__contacts-section">
        <p class="purchase-page__contacts-title">Заполните необходимую информацию для оформления покупки</p>
      </div>
      <form [formGroup]="purchaseForm" (ngSubmit)="submitForm()" class="purchase-page__form">
        @for (field of purchaseFields(); track field.name) { @switch (field.type) { @case ('string') {
        <app-form-field
          [control]="field.control"
          [label]="field.title"
          [required]="true"
          [type]="field.type"
          [hasError]="!field.control.valid && field.control.touched"
          [errorMessage]="field.control | localizeFieldError"
          [placeholder]="field.title"
          [fieldId]="field.name"
        ></app-form-field>
        } @case ('number') {
        <app-form-field
          [control]="field.control"
          [label]="field.title"
          [required]="true"
          [type]="field.type"
          [hasError]="!field.control.valid && field.control.touched"
          [errorMessage]="field.control | localizeFieldError"
          [placeholder]="field.title"
          [fieldId]="field.name"
        ></app-form-field>
        } @case ('boolean') {
        <app-radio-group
          [control]="field.control"
          [label]="field.title"
          [hasError]="!field.control.valid && field.control.touched"
          [required]="true"
          [options]="[
            { value: 'true', label: 'Да' },
            { value: 'false', label: 'Нет' }
          ]"
          [name]="field.name"
        ></app-radio-group>
        } @case ('date') {
        <app-date-picker
          [hasError]="!field.control.valid && field.control.touched"
          [control]="field.control"
          [label]="field.title"
          [required]="true"
          [placeholder]="field.title"
          [fieldId]="field.name"
        ></app-date-picker>
        } @default {
        <app-form-field
          [hasError]="!field.control.valid && field.control.touched"
          [control]="field.control"
          [label]="field.title"
          [required]="true"
          [type]="field.type"
          [placeholder]="field.title"
          [fieldId]="field.name"
        ></app-form-field>
        } } }

        <div class="purchase-page__checkboxes">
          <label class="purchase-page__checkbox-label">
            <input
              type="checkbox"
              [formControl]="getCheckboxControl('personalDataConsent')"
              class="purchase-page__checkbox"
            />
            <span class="purchase-page__checkbox-text">
              Предоставляя данные я даю 
              <a href="https://moto.vokrug.city/user-politic" target="_blank" class="purchase-page__checkbox-link">согласие на обработку ПДн(ФиО, дата рождения...)</a>
            </span>
          </label>
          @if (!getCheckboxControl('personalDataConsent').valid && getCheckboxControl('personalDataConsent').touched) {
          <p class="purchase-page__checkbox-error">Это поле обязательно для заполнения</p>
          }

          <label class="purchase-page__checkbox-label">
            <input
              type="checkbox"
              [formControl]="getCheckboxControl('insuranceConfirmation')"
              class="purchase-page__checkbox"
            />
            <span class="purchase-page__checkbox-text">
              Подтверждаю, что обладаю действующим страховым полисом страхования жизни и здоровья от несчастных случаев и медицинским допуском.
            </span>
          </label>
          @if (!getCheckboxControl('insuranceConfirmation').valid && getCheckboxControl('insuranceConfirmation').touched) {
          <p class="purchase-page__checkbox-error">Это поле обязательно для заполнения</p>
          }

          <label class="purchase-page__checkbox-label">
            <input
              type="checkbox"
              [formControl]="getCheckboxControl('sportsLicenseAgreement')"
              class="purchase-page__checkbox"
            />
            <span class="purchase-page__checkbox-text">
              Ознакомлен и согласен с
              <a
                href="https://www.mfr.ru/upload/iblock/731/n6i723hy9q70815eyfm61902cx2fvi76/%D0%9F%D0%BE%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BE%20%D1%81%D0%BF%D0%BE%D1%80%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D1%85%20%D1%80%D0%B0%D0%B7%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D1%8F%D1%85(%D0%BB%D0%B8%D1%86%D0%B5%D0%BD%D0%B7%D0%B8%D1%8F%20%D1%81%D0%BF%D0%BE%D1%80%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B3%D0%BE%20%D1%81%D1%83%D0%B4%D1%8C%D0%B8).pdf"
                target="_blank"
                class="purchase-page__checkbox-link"
              >
                положением о спортивных разрешениях
              </a>
            </span>
          </label>
          @if (!getCheckboxControl('sportsLicenseAgreement').valid && getCheckboxControl('sportsLicenseAgreement').touched) {
          <p class="purchase-page__checkbox-error">Это поле обязательно для заполнения</p>
          }
        </div>

        <button type="submit" class="purchase-page__submit">Оформить покупку</button>
        <p class="purchase-page__terms">Оформляя покупку, вы соглашаетесь с <a href="https://moto.vokrug.city/offer" target="_blank" class="purchase-page__terms-link">публичной офертой</a></p>
      </form>
      } @if (purchaseContactsForm && _purchaseState() === 'contacts') {
      <div class="purchase-page__contacts-section">
        <p class="purchase-page__contacts-title">Заполните контактную информацию куда будет отправлен товар</p>
      </div>
      <form [formGroup]="purchaseContactsForm" (ngSubmit)="initializePurchaseContactsForm()" class="purchase-page__form">
        <app-form-field
          [control]="getCurrentControlInContactsForm('email')"
          label="Электронная почта"
          [required]="true"
          [type]="'email'"
        ></app-form-field>
        <app-form-field [control]="getCurrentControlInContactsForm('phone')" label="Телефон" [required]="true" [type]="'tel'"></app-form-field>

        <div class="purchase-page__receipt">
          <div class="purchase-page__receipt-title">Стоимость товара</div>
          <div class="purchase-page__products-list">
            <div class="purchase-page__product-item">
              <div class="purchase-page__product-info">
                <span class="purchase-page__product-name">{{ product()?.name }}</span>
                <span class="purchase-page__product-quantity">1 шт</span>
              </div>
              <div class="purchase-page__product-price">{{ product()?.price }} ₽</div>
            </div>
          </div>

          <div class="purchase-page__receipt-divider"></div>

          <div class="purchase-page__receipt-row">
            <span class="purchase-page__receipt-label">Товары</span>
            <span class="purchase-page__receipt-value">{{ product()?.price }} ₽</span>
          </div>

          <div class="purchase-page__receipt-row">
            <span class="purchase-page__receipt-label">Сервисный сбор</span>
            <span class="purchase-page__receipt-value">{{ getServiceFee() }} ₽</span>
          </div>

          <div class="purchase-page__receipt-divider"></div>

          <div class="purchase-page__total">
            <span class="purchase-page__total-label">Итого</span>
            <span class="purchase-page__total-amount">{{ getTotalPrice() }} ₽</span>
          </div>
        </div>
        <button type="submit" class="purchase-page__submit">Оформить покупку</button>
      </form>
      }
    </div>
    } @else {
    <div class="purchase-page__loading">
      <p>Загрузка...</p>
    </div>
    }
  </div>
</app-page-container>

<app-page-container>
  <div class="purchase-page">
    <app-back-button [customBack]="true" (click)="goBackToProduct()" text="← Вернуться к товару"></app-back-button>

    @if (product()) {
    <div class="purchase-page__card">
      <h1 class="purchase-page__title">{{ product()?.name }}</h1>
      @if (_purchaseState() === 'initial') {
        <div class="purchase-page__contacts-section">
          <p class="purchase-page__contacts-title">Заполните необходимую информацию для оформления покупки</p>
        </div>
      <form [formGroup]="purchaseForm" (ngSubmit)="submitForm()" class="purchase-page__form">
        @for (field of purchaseFields(); track field.name) { @switch (field.type) { @case ('string') {
        <app-form-field
          [control]="field.control"
          [label]="field.title"
          [required]="true"
          [type]="field.type"
          [hasError]="!field.control.valid && field.control.touched"
          [errorMessage]="field.control | localizeFieldError"
          [placeholder]="field.title"
          [fieldId]="field.name"
        ></app-form-field>
        } @case ('number') {
        <app-form-field
          [control]="field.control"
          [label]="field.title"
          [required]="true"
          [type]="field.type"
          [hasError]="!field.control.valid && field.control.touched"
          [errorMessage]="field.control | localizeFieldError"
          [placeholder]="field.title"
          [fieldId]="field.name"
        ></app-form-field>
        } @case ('boolean') {
        <app-radio-group
          [control]="field.control"
          [label]="field.title"
          [hasError]="!field.control.valid && field.control.touched"
          [required]="true"
          [options]="[
            { value: 'true', label: 'Да' },
            { value: 'false', label: 'Нет' }
          ]"
          [name]="field.name"
        ></app-radio-group>
        } @case ('date') {
        <app-date-picker
          [hasError]="!field.control.valid && field.control.touched"
          [control]="field.control"
          [label]="field.title"
          [required]="true"
          [placeholder]="field.title"
          [fieldId]="field.name"
        ></app-date-picker>
        } @default {
        <app-form-field
          [hasError]="!field.control.valid && field.control.touched"
          [control]="field.control"
          [label]="field.title"
          [required]="true"
          [type]="field.type"
          [placeholder]="field.title"
          [fieldId]="field.name"
        ></app-form-field>
        } } }
        <button type="submit" class="purchase-page__submit">Оформить покупку</button>
        <p class="purchase-page__terms">Оформляя покупку, вы соглашаетесь с нашими условиями и правилами</p>
      </form>
      } @if (purchaseContactsForm && _purchaseState() === 'contacts') {
      <div class="purchase-page__contacts-section">
        <p class="purchase-page__contacts-title">Заполните контактную информацию куда будет отправлен товар</p>
      </div>
      <form [formGroup]="purchaseContactsForm" (ngSubmit)="initializePurchaseContactsForm()" class="purchase-page__form">
        <app-form-field
          [control]="getCurrentControlInContactsForm('email')"
          label="Электронная почта"
          [required]="true"
          [type]="'email'"
        ></app-form-field>
        <app-form-field [control]="getCurrentControlInContactsForm('phone')" label="Телефон" [required]="true" [type]="'tel'"></app-form-field>

        <div class="purchase-page__receipt">
          <div class="purchase-page__receipt-title">Стоимость товара</div>
          <div class="purchase-page__products-list">
            <div class="purchase-page__product-item">
              <div class="purchase-page__product-info">
                <span class="purchase-page__product-name">{{ product()?.name }}</span>
                <span class="purchase-page__product-quantity">1 шт</span>
              </div>
              <div class="purchase-page__product-price">{{ product()?.price }} ₽</div>
            </div>
          </div>

          <div class="purchase-page__receipt-divider"></div>

          <div class="purchase-page__receipt-row">
            <span class="purchase-page__receipt-label">Товары</span>
            <span class="purchase-page__receipt-value">{{ product()?.price }} ₽</span>
          </div>

          <div class="purchase-page__receipt-row">
            <span class="purchase-page__receipt-label">Сервисный сбор</span>
            <span class="purchase-page__receipt-value">{{ getServiceFee() }} ₽</span>
          </div>

          <div class="purchase-page__receipt-divider"></div>

          <div class="purchase-page__total">
            <span class="purchase-page__total-label">Итого</span>
            <span class="purchase-page__total-amount">{{ getTotalPrice() }} ₽</span>
          </div>
        </div>
        <button type="submit" class="purchase-page__submit">Оформить покупку</button>
      </form>
      }
    </div>
    } @else {
    <div class="purchase-page__loading">
      <p>Загрузка...</p>
    </div>
    }
  </div>
</app-page-container>
